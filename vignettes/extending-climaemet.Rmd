---
title: "Extending climaemet"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extending climaemet}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
resource_files:
   - vignettes/example-gif.gif
---

<!-- extending-climaemet.Rmd is generated from extending-climaemet.Rmd.orig. Please edit that file -->



**climaemet** provides several functions for accessing a selection of endpoints
of the [AEMET API tool](https://opendata.aemet.es/dist/index.html?). However,
this package does not cover in full all the capabilities of the API.

For that reason, we provide the `get_data_aemet()` function, that allows to
access any API endpoint freely. The drawback is that the user would need to
handle the results by him/herself.


``` r
library(climaemet)
```

## Example: Normalized text

Some API endpoints, as `predicciones-normalizadas-texto`, provides the results
as plain text on natural language. These results are not parsed by
**climaemet**, but can be retrieved as this:


``` r
# endpoint, today forecast

today <- "/api/prediccion/nacional/hoy"

# Metadata
knitr::kable(get_metadata_aemet(today))
```



|unidad_generadora                           |descripcion                                                                                                                              |periodicidad                                                                                                                                                                                                               |formato   |copyright                                                                                               |notaLegal                          |
|:-------------------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------|:-------------------------------------------------------------------------------------------------------|:----------------------------------|
|Grupo Funcional de Predicción de Referencia |Predicción general nacional para hoy / mañana / pasado mañana / medio plazo (tercer y cuarto día) / tendencia (del quinto al noveno día) |Disponibilidad. Para hoy, solo se confecciona si hay cambios significativos. Para mañana y pasado mañana diaria a las 15:00 h.o.p.. Para el medio plazo diaria a las 16:00 h.o.p.. La tendencia, diaria a las 18:30 h.o.p. |ascii/txt |© AEMET. Autorizado el uso de la información y su reproducción citando a AEMET como autora de la misma. |https://www.aemet.es/es/nota_legal |



``` r

# Data
pred_today <- get_data_aemet(today)
#> 
#> Results are MIME type: text/plain
#> Returning data as string
```


``` r
# Produce a result

clean <- gsub("\r", "\n", pred_today, fixed = TRUE)
clean <- gsub("\n\n\n", "\n", clean, fixed = TRUE)

cat(paste("---\n\n", clean, "\n---"))
```

---

 AGENCIA ESTATAL DE METEOROLOGÍA
PREDICCIÓN GENERAL PARA ESPAÑA 
DÍA 19 DE JUNIO DE 2024 A LAS 15:32 HORA OFICIAL
PREDICCIÓN VÁLIDA PARA EL MIÉRCOLES 19

A.- FENÓMENOS SIGNIFICATIVOS
Probabilidad de chubascos y tormentas localmente fuertes en
litorales de Galicia y Asturias a primeras horas, y en los
entornos cantábrico y pirenaico occidentales, sin descartarlos en
Extremadura y Andalucía occidental, por la tarde. Intervalos de
viento fuerte en litorales de Alborán y zonas expuestas de
Canarias. Rissagas en Menorca.

B.- PREDICCIÓN
Una DANA se acercará al oeste Peninsular propiciando una
situación de inestabilidad con cielos nubosos o cubiertos en
Galicia, entorno cantábrico y suroeste peninsular; también en el
resto de la vertiente atlántica, alto Ebro y área pirenaica en
la segunda mitad del día, predominando los cielos poco nubosos o
con intervalos de nubes bajas en la primera. Se prevén
precipitaciones ocasionalmente acompañadas de tormenta desde
primera horas en el entorno cantábrico y norte de Galicia, sin
descartarlas localmente fuertes en áreas de litoral de Asturias y
Lugo, que por la tarde se extenderán al resto de la mitad oeste
peninsular, así como al entorno del alto Ebro, norte de la
Ibérica, Cantábrico oriental y Pirineo y aledaños al sur. Se
prevén más intensas en los entornos cantábrico y pirenaico
occidentales, con probabilidad de llegar a localmente fuertes, y
sin descartarlo en áreas de Extremadura y Andalucía occidental.
En el resto de la Península y Baleares se darán intervalos de
nubes medias y altas yendo a más a lo largo del día y dejando
probables precipitaciones con tormenta en áreas del tercio este,
sin descartarlas en Baleares. Intervalos de nubes en los nortes y
este del archipiélago canario, sin descartar precipitaciones
débiles dispersas en las islas montañosas, y poco nuboso en el
resto.

Se prevé la presencia de calima en Baleares y rissagas en
Menorca.

Las temperaturas descenderán de forma prácticamente
generalizada, acusadamente en interiores de la mitad oriental
peninsular, y con algunos aumentos en litorales del Levante,
fachada atlántica gallega, meseta Norte y norte de Baleares.

Predominarán los vientos de componente norte en Galicia y
vertiente cantábrica, de sur y este en la mitad norte del área
mediterránea y nordeste peninsular, y de sur y oeste en el resto.
Se prevén intervalos de fuerte en litorales de Alborán, que no
se descartan en los del oeste de Galicia. Alisio en Canarias, con
intervalos de fuerte en los canales entre islas.

 
---

## Example: Maps

AEMET also provides map data, usually on `image/gif` format. One way to get this
kind of data is as follows:


``` r
# Endpoint of a map
a_map <- "/api/mapasygraficos/analisis"

# Metadata
knitr::kable(get_metadata_aemet(a_map))
```



|unidad_generadora                 |descripción                                |periodicidad                                                                              |formato   |copyright                                                                                               |notaLegal                          |
|:---------------------------------|:------------------------------------------|:-----------------------------------------------------------------------------------------|:---------|:-------------------------------------------------------------------------------------------------------|:----------------------------------|
|Grupo Funcional de Jefes de Turno |Mapas de análisis de frentes en superficie |Dos veces al día, a las 02:00 y 14:00 h.o.p. en invierno y a las 03:00 y 15:00 en verano. |image/gif |© AEMET. Autorizado el uso de la información y su reproducción citando a AEMET como autora de la misma. |https://www.aemet.es/es/nota_legal |



``` r

the_map <- get_data_aemet(a_map)
#> 
#> Results are MIME type: image/gif
#> Returning raw data
```

``` r


# Write as gif and include it
giffile <- "example-gif.gif"
writeBin(the_map, giffile)

# Display on the vignette
knitr::include_graphics(giffile)
```

<div class="figure">
<img src="example-gif.gif" alt="Example: Surface analysis map provided by AEMET" width="100%" />
<p class="caption">Example: Surface analysis map provided by AEMET</p>
</div>

## Example: Beach forecast

This example is more elaborated, since the user would need to process the
results provided by the AEMET API.

In first place we need to get the database of beaches:


``` r
library(readr)
library(tidyr)
library(dplyr)

db_beach <- read_csv2("https://www.aemet.es/documentos/es/eltiempo/prediccion/playas/Playas_codigos.csv",
  show_col_types = FALSE,
  locale = locale(encoding = "ISO-8859-1"),
  trim_ws = TRUE
)
#> ℹ Using "','" as decimal and "'.'" as grouping mark. Use `read_delim()` for more control.
```

``` r

db_beach
#> # A tibble: 591 × 8
#>    ID_PLAYA NOMBRE_PLAYA               ID_PROVINCIA NOMBRE_PROVINCIA ID_MUNICIPIO NOMBRE_MUNICIPIO LATITUD        LONGITUD      
#>    <chr>    <chr>                      <chr>        <chr>            <chr>        <chr>            <chr>          <chr>         
#>  1 0301101  Raco de l'Albir            03           Alacant/Alicante 03011        l'Alfàs del Pi   "38º 34' 31\"" "-00º 03' 52\…
#>  2 0301401  Sant Joan / San Juan       03           Alacant/Alicante 03014        Alicante/Alacant "38º 22' 48\"" "-00º 24' 32\…
#>  3 0301408  El Postiguet               03           Alacant/Alicante 03014        Alicante/Alacant "38º 20' 46\"" "-00º 28' 38\…
#>  4 0301410  Saladar                    03           Alacant/Alicante 03014        Alicante/Alacant "38º 17' 02\"" "-00º 31' 08\…
#>  5 0301808  La Roda                    03           Alacant/Alicante 03018        Altea            "38º 36' 29\"" "-00º 02' 16\…
#>  6 0301809  Cap Blanch                 03           Alacant/Alicante 03018        Altea            "38º 35' 36\"" "-00º 03' 10\…
#>  7 0303102  Llevant / Playa de Levante 03           Alacant/Alicante 03031        Benidorm         "38º 32' 12\"" "-00º 07' 05\…
#>  8 0303104  Ponent / Playa de Poniente 03           Alacant/Alicante 03031        Benidorm         "38º 32' 14\"" "-00º 08' 55\…
#>  9 0304105  Cala Fustera               03           Alacant/Alicante 03041        Benissa          "38º 39' 53\"" "0º 05' 16\"" 
#> 10 0304704  La Fossa                   03           Alacant/Alicante 03047        Calp             "38º 38' 46\"" "0º 04' 24\"" 
#> # ℹ 581 more rows
```

Next, we can check the response of the API for a specific case:


``` r
# Heliopolis, Benicassim

id_beach <- "1202805"

api_entry <- "/api/prediccion/especifica/playa/"

api_call <- paste0(api_entry, id_beach)

# And we make the call

beach_api <- get_data_aemet(api_call)

glimpse(beach_api)
#> Rows: 1
#> Columns: 6
#> $ origen     <df[,5]> <data.frame[1 x 5]>
#> $ elaborado  <chr> "2024-06-20T08:00:20"
#> $ nombre     <chr> "Heliopolis"
#> $ localidad  <int> 12028
#> $ prediccion <df[,1]> <data.frame[1 x 1]>
#> $ id         <int> 1202805
```

The response needs further treatment, the forecast is in the `prediccion` column
as a data set. We can have first a look:


``` r
glimpse(beach_api$prediccion$dia[[1]])
#> Rows: 3
#> Columns: 11
#> $ estadoCielo <df[,5]> <data.frame[3 x 5]>
#> $ viento      <df[,5]> <data.frame[3 x 5]>
#> $ oleaje      <df[,5]> <data.frame[3 x 5]>
#> $ tMaxima     <df[,2]> <data.frame[3 x 2]>
#> $ sTermica    <df[,3]> <data.frame[3 x 3]>
#> $ tAgua       <df[,2]> <data.frame[3 x 2]>
#> $ uvMax       <df[,2]> <data.frame[3 x 2]>
#> $ fecha       <int> 20240620, 20240621, 20240622
#> $ tmaxima     <df[,2]> <data.frame[3 x 2]>
#> $ stermica    <df[,3]> <data.frame[3 x 3]>
#> $ tagua       <df[,2]> <data.frame[3 x 2]>
```

We need then to un-nest the data frame of forecast, and perform a few additional
conversions of `Date` columns:


``` r
for_pred <- beach_api$prediccion$dia[[1]]

# Need cols now

coln <- names(for_pred)


for_pred_2 <- unnest(for_pred, names_sep = "_", cols = all_of(coln)) %>%
  mutate(fecha = as.Date(as.character(fecha),
    tryFormats = c("%Y-%m-%d", "%Y/%m/%d", "%Y%m%d")
  )) %>%
  # We add interesting info of the metadata
  mutate(
    id_beach = beach_api$id,
    elaborado = lubridate::as_datetime(beach_api$elaborado)
  ) %>%
  relocate(id_beach, elaborado, fecha)

glimpse(for_pred_2)
#> Rows: 3
#> Columns: 34
#> $ id_beach                 <int> 1202805, 1202805, 1202805
#> $ elaborado                <dttm> 2024-06-20 08:00:20, 2024-06-20 08:00:20, 2024-06-20 08:00:20
#> $ fecha                    <date> 2024-06-20, 2024-06-21, 2024-06-22
#> $ estadoCielo_value        <chr> "", "", ""
#> $ estadoCielo_f1           <int> 110, 100, 100
#> $ estadoCielo_descripcion1 <chr> "nuboso", "despejado", "despejado"
#> $ estadoCielo_f2           <int> 100, 100, 110
#> $ estadoCielo_descripcion2 <chr> "despejado", "despejado", "nuboso"
#> $ viento_value             <chr> "", "", ""
#> $ viento_f1                <int> 210, 210, 210
#> $ viento_descripcion1      <chr> "flojo", "flojo", "flojo"
#> $ viento_f2                <int> 210, 210, 210
#> $ viento_descripcion2      <chr> "flojo", "flojo", "flojo"
#> $ oleaje_value             <chr> "", "", ""
#> $ oleaje_f1                <int> 320, 310, 310
#> $ oleaje_descripcion1      <chr> "moderado", "débil", "débil"
#> $ oleaje_f2                <int> 310, 310, 310
#> $ oleaje_descripcion2      <chr> "débil", "débil", "débil"
#> $ tMaxima_value            <chr> "", "", ""
#> $ tMaxima_valor1           <int> 28, 28, 29
#> $ sTermica_value           <chr> "", "", ""
#> $ sTermica_valor1          <int> 460, 460, 460
#> $ sTermica_descripcion1    <chr> "calor agradable", "calor agradable", "calor agradable"
#> $ tAgua_value              <chr> "", "", ""
#> $ tAgua_valor1             <int> 23, 23, 23
#> $ uvMax_value              <chr> "", "", ""
#> $ uvMax_valor1             <int> 7, 8, 8
#> $ tmaxima_value            <chr> "", "", ""
#> $ tmaxima_valor1           <int> 28, 28, 29
#> $ stermica_value           <chr> "", "", ""
#> $ stermica_valor1          <int> 460, 460, 460
#> $ stermica_descripcion1    <chr> "calor agradable", "calor agradable", "calor agradable"
#> $ tagua_value              <chr> "", "", ""
#> $ tagua_valor1             <int> 23, 23, 23
```

Once that we have the helper, we can wrap everything to provide a full-fledged
function:


``` r
# Wrap on a function
aemet_usr__forecast_beach <- function(id_beach = NULL) {
  api_entry <- "/api/prediccion/especifica/playa/"
  api_call <- paste0(api_entry, id_beach)

  beach_api <- get_data_aemet(api_call)
  for_pred <- beach_api$prediccion$dia[[1]]

  # Need cols now

  coln <- names(for_pred)


  for_pred_2 <- unnest(for_pred, names_sep = "_", cols = all_of(coln)) %>%
    mutate(fecha = as.Date(as.character(fecha),
      tryFormats = c("%Y-%m-%d", "%Y/%m/%d", "%Y%m%d")
    )) %>%
    # We add interesting info of the metadata
    mutate(
      id_beach = beach_api$id,
      elaborado = lubridate::as_datetime(beach_api$elaborado)
    ) %>%
    relocate(id_beach, elaborado, fecha)

  for_pred_2
}
```

Here we go! We already have our function. We can try it now:


``` r
aemet_usr__forecast_beach("0301401") %>%
  glimpse()
#> Rows: 3
#> Columns: 34
#> $ id_beach                 <int> 301401, 301401, 301401
#> $ elaborado                <dttm> 2024-06-20 08:00:20, 2024-06-20 08:00:20, 2024-06-20 08:00:20
#> $ fecha                    <date> 2024-06-20, 2024-06-21, 2024-06-22
#> $ estadoCielo_value        <chr> "", "", ""
#> $ estadoCielo_f1           <int> 100, 100, 100
#> $ estadoCielo_descripcion1 <chr> "despejado", "despejado", "despejado"
#> $ estadoCielo_f2           <int> 100, 100, 100
#> $ estadoCielo_descripcion2 <chr> "despejado", "despejado", "despejado"
#> $ viento_value             <chr> "", "", ""
#> $ viento_f1                <int> 210, 210, 210
#> $ viento_descripcion1      <chr> "flojo", "flojo", "flojo"
#> $ viento_f2                <int> 220, 210, 210
#> $ viento_descripcion2      <chr> "moderado", "flojo", "flojo"
#> $ oleaje_value             <chr> "", "", ""
#> $ oleaje_f1                <int> 310, 310, 310
#> $ oleaje_descripcion1      <chr> "débil", "débil", "débil"
#> $ oleaje_f2                <int> 310, 320, 310
#> $ oleaje_descripcion2      <chr> "débil", "moderado", "débil"
#> $ tMaxima_value            <chr> "", "", ""
#> $ tMaxima_valor1           <int> 29, 27, 27
#> $ sTermica_value           <chr> "", "", ""
#> $ sTermica_valor1          <int> 460, 460, 460
#> $ sTermica_descripcion1    <chr> "calor agradable", "calor agradable", "calor agradable"
#> $ tAgua_value              <chr> "", "", ""
#> $ tAgua_valor1             <int> 23, 23, 23
#> $ uvMax_value              <chr> "", "", ""
#> $ uvMax_valor1             <int> 8, 9, 8
#> $ tmaxima_value            <chr> "", "", ""
#> $ tmaxima_valor1           <int> 29, 27, 27
#> $ stermica_value           <chr> "", "", ""
#> $ stermica_valor1          <int> 460, 460, 460
#> $ stermica_descripcion1    <chr> "calor agradable", "calor agradable", "calor agradable"
#> $ tagua_value              <chr> "", "", ""
#> $ tagua_valor1             <int> 23, 23, 23
```

``` r


# Several using apply and bind_rows
several <- db_beach$ID_PLAYA[7:10] %>%
  lapply(aemet_usr__forecast_beach) %>%
  bind_rows()

glimpse(several)
#> Rows: 12
#> Columns: 34
#> $ id_beach                 <int> 303102, 303102, 303102, 303104, 303104, 303104, 304105, 304105, 304105, 304704, 304704, 304704
#> $ elaborado                <dttm> 2024-06-20 08:00:20, 2024-06-20 08:00:20, 2024-06-20 08:00:20, 2024-06-20 08:00:20, 2024-06-2…
#> $ fecha                    <date> 2024-06-20, 2024-06-21, 2024-06-22, 2024-06-20, 2024-06-21, 2024-06-22, 2024-06-20, 2024-06-…
#> $ estadoCielo_value        <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ estadoCielo_f1           <int> 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100
#> $ estadoCielo_descripcion1 <chr> "despejado", "despejado", "despejado", "despejado", "despejado", "despejado", "despejado", "…
#> $ estadoCielo_f2           <int> 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100, 100
#> $ estadoCielo_descripcion2 <chr> "despejado", "despejado", "despejado", "despejado", "despejado", "despejado", "despejado", "d…
#> $ viento_value             <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ viento_f1                <int> 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210, 210
#> $ viento_descripcion1      <chr> "flojo", "flojo", "flojo", "flojo", "flojo", "flojo", "flojo", "flojo", "flojo", "flojo", "fl…
#> $ viento_f2                <int> 220, 220, 210, 220, 220, 210, 220, 210, 220, 220, 210, 220
#> $ viento_descripcion2      <chr> "moderado", "moderado", "flojo", "moderado", "moderado", "flojo", "moderado", "flojo", "moder…
#> $ oleaje_value             <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ oleaje_f1                <int> 320, 320, 310, 320, 320, 310, 310, 310, 310, 310, 310, 310
#> $ oleaje_descripcion1      <chr> "moderado", "moderado", "débil", "moderado", "moderado", "débil", "débil", "débil", "débil", …
#> $ oleaje_f2                <int> 320, 310, 310, 320, 320, 310, 310, 320, 310, 310, 320, 310
#> $ oleaje_descripcion2      <chr> "moderado", "débil", "débil", "moderado", "moderado", "débil", "débil", "moderado", "débil", …
#> $ tMaxima_value            <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ tMaxima_valor1           <int> 25, 27, 26, 26, 27, 26, 28, 28, 28, 27, 28, 28
#> $ sTermica_value           <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ sTermica_valor1          <int> 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460
#> $ sTermica_descripcion1    <chr> "calor agradable", "calor agradable", "calor agradable", "calor agradable", "calor agradable"…
#> $ tAgua_value              <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ tAgua_valor1             <int> 23, 23, 25, 23, 23, 24, 23, 24, 25, 23, 24, 25
#> $ uvMax_value              <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ uvMax_valor1             <int> 8, 9, 8, 8, 9, 8, 8, 9, 8, 8, 9, 8
#> $ tmaxima_value            <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ tmaxima_valor1           <int> 25, 27, 26, 26, 27, 26, 28, 28, 28, 27, 28, 28
#> $ stermica_value           <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ stermica_valor1          <int> 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460
#> $ stermica_descripcion1    <chr> "calor agradable", "calor agradable", "calor agradable", "calor agradable", "calor agradable"…
#> $ tagua_value              <chr> "", "", "", "", "", "", "", "", "", "", "", ""
#> $ tagua_valor1             <int> 23, 23, 25, 23, 23, 24, 23, 24, 25, 23, 24, 25
```
